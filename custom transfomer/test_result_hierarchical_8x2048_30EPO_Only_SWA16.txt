==================================================
<> Training Transformer Model (AMP Enabled)
<> Mode: SWA Only (Ablation)
==================================================
/home/ztang13/workspace/SparseAttention/myenv/lib/python3.12/site-packages/torch/optim/lr_scheduler.py:62: UserWarning: The verbose parameter is deprecated. Please use get_last_lr() to access the learning rate.
  warnings.warn(
/home/ztang13/workspace/SparseAttention/custom transfomer/Hierarchical_Transformer_WikiText103_Switch.py:641: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  scaler = torch.cuda.amp.GradScaler()
Epoch 1/30:   0%|                                                                                                                                           | 0/6258 [00:00<?, ?it/s]/home/ztang13/workspace/SparseAttention/custom transfomer/Hierarchical_Transformer_WikiText103_Switch.py:668: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with torch.cuda.amp.autocast():
Epoch 1/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:27<00:00,  2.11it/s, loss=6.0262, ppl=414.15]
<> Validating...
/home/ztang13/workspace/SparseAttention/custom transfomer/Hierarchical_Transformer_WikiText103_Switch.py:707: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with torch.cuda.amp.autocast():

<> Epoch 1 Results:
<>  Time: 0:49:30
Train Loss: 6.6418 | Train PPL: 766.51
Valid Loss: 5.8161 | Valid PPL: 335.65
<> Saved new best model with validation loss: 5.8161
Epoch 2/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:28<00:00,  2.11it/s, loss=5.6314, ppl=279.05]
<> Validating...

<> Epoch 2 Results:
<>  Time: 0:49:31
Train Loss: 5.6937 | Train PPL: 296.98
Valid Loss: 5.3791 | Valid PPL: 216.84
<> Saved new best model with validation loss: 5.3791
Epoch 3/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:27<00:00,  2.11it/s, loss=5.4297, ppl=228.08]
<> Validating...

<> Epoch 3 Results:
<>  Time: 0:49:30
Train Loss: 5.3894 | Train PPL: 219.07
Valid Loss: 5.1672 | Valid PPL: 175.42
<> Saved new best model with validation loss: 5.1672
Epoch 4/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:28<00:00,  2.11it/s, loss=5.3005, ppl=200.44]
<> Validating...

<> Epoch 4 Results:
<>  Time: 0:49:31
Train Loss: 5.2122 | Train PPL: 183.49
Valid Loss: 5.0332 | Valid PPL: 153.43
<> Saved new best model with validation loss: 5.0332
Epoch 5/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:14<00:00,  2.12it/s, loss=5.2150, ppl=184.01]
<> Validating...

<> Epoch 5 Results:
<>  Time: 0:49:17
Train Loss: 5.0890 | Train PPL: 162.23
Valid Loss: 4.9402 | Valid PPL: 139.79
<> Saved new best model with validation loss: 4.9402
Epoch 6/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:21<00:00,  2.11it/s, loss=5.1444, ppl=171.47]
<> Validating...

<> Epoch 6 Results:
<>  Time: 0:49:24
Train Loss: 4.9958 | Train PPL: 147.79
Valid Loss: 4.8658 | Valid PPL: 129.78
<> Saved new best model with validation loss: 4.8658
Epoch 7/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [54:23<00:00,  1.92it/s, loss=5.0895, ppl=162.31]
<> Validating...

<> Epoch 7 Results:
<>  Time: 0:54:26
Train Loss: 4.9218 | Train PPL: 137.24
Valid Loss: 4.8095 | Valid PPL: 122.67
<> Saved new best model with validation loss: 4.8095
Epoch 8/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:38<00:00,  2.10it/s, loss=5.0401, ppl=154.48]
<> Validating...

<> Epoch 8 Results:
<>  Time: 0:49:41
Train Loss: 4.8609 | Train PPL: 129.14
Valid Loss: 4.7641 | Valid PPL: 117.23
<> Saved new best model with validation loss: 4.7641
Epoch 9/30: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:25<00:00,  2.11it/s, loss=5.0075, ppl=149.53]
<> Validating...

<> Epoch 9 Results:
<>  Time: 0:49:28
Train Loss: 4.8099 | Train PPL: 122.72
Valid Loss: 4.7273 | Valid PPL: 112.99
<> Saved new best model with validation loss: 4.7273
Epoch 10/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:19<00:00,  2.11it/s, loss=4.9809, ppl=145.61]
<> Validating...

<> Epoch 10 Results:
<>  Time: 0:49:22
Train Loss: 4.7662 | Train PPL: 117.47
Valid Loss: 4.6937 | Valid PPL: 109.26
<> Saved new best model with validation loss: 4.6937
Epoch 11/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:19<00:00,  2.11it/s, loss=4.9557, ppl=141.99]
<> Validating...

<> Epoch 11 Results:
<>  Time: 0:49:22
Train Loss: 4.7289 | Train PPL: 113.17
Valid Loss: 4.6677 | Valid PPL: 106.45
<> Saved new best model with validation loss: 4.6677
Epoch 12/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:31<00:00,  2.11it/s, loss=4.9304, ppl=138.43]
<> Validating...

<> Epoch 12 Results:
<>  Time: 0:49:34
Train Loss: 4.6957 | Train PPL: 109.48
Valid Loss: 4.6461 | Valid PPL: 104.17
<> Saved new best model with validation loss: 4.6461
Epoch 13/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:31<00:00,  2.11it/s, loss=4.9020, ppl=134.56]
<> Validating...

<> Epoch 13 Results:
<>  Time: 0:49:34
Train Loss: 4.6664 | Train PPL: 106.31
Valid Loss: 4.6252 | Valid PPL: 102.02
<> Saved new best model with validation loss: 4.6252
Epoch 14/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:30<00:00,  2.11it/s, loss=4.8853, ppl=132.33]
<> Validating...

<> Epoch 14 Results:
<>  Time: 0:49:33
Train Loss: 4.6404 | Train PPL: 103.58
Valid Loss: 4.6066 | Valid PPL: 100.15
<> Saved new best model with validation loss: 4.6066
Epoch 15/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:31<00:00,  2.11it/s, loss=4.8712, ppl=130.48]
<> Validating...

<> Epoch 15 Results:
<>  Time: 0:49:34
Train Loss: 4.6173 | Train PPL: 101.22
Valid Loss: 4.5898 | Valid PPL: 98.47
<> Saved new best model with validation loss: 4.5898
Epoch 16/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:33<00:00,  2.10it/s, loss=4.8539, ppl=128.24]
<> Validating...

<> Epoch 16 Results:
<>  Time: 0:49:36
Train Loss: 4.5969 | Train PPL: 99.18
Valid Loss: 4.5750 | Valid PPL: 97.03
<> Saved new best model with validation loss: 4.5750
Epoch 17/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:32<00:00,  2.11it/s, loss=4.8417, ppl=126.69]
<> Validating...

<> Epoch 17 Results:
<>  Time: 0:49:35
Train Loss: 4.5789 | Train PPL: 97.40
Valid Loss: 4.5646 | Valid PPL: 96.02
<> Saved new best model with validation loss: 4.5646
Epoch 18/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:33<00:00,  2.10it/s, loss=4.8368, ppl=126.06]
<> Validating...

<> Epoch 18 Results:
<>  Time: 0:49:36
Train Loss: 4.5621 | Train PPL: 95.78
Valid Loss: 4.5541 | Valid PPL: 95.03
<> Saved new best model with validation loss: 4.5541
Epoch 19/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:32<00:00,  2.11it/s, loss=4.8188, ppl=123.82]
<> Validating...

<> Epoch 19 Results:
<>  Time: 0:49:35
Train Loss: 4.5469 | Train PPL: 94.34
Valid Loss: 4.5444 | Valid PPL: 94.11
<> Saved new best model with validation loss: 4.5444
Epoch 20/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:36<00:00,  2.10it/s, loss=4.8132, ppl=123.13]
<> Validating...

<> Epoch 20 Results:
<>  Time: 0:49:39
Train Loss: 4.5338 | Train PPL: 93.11
Valid Loss: 4.5341 | Valid PPL: 93.14
<> Saved new best model with validation loss: 4.5341
Epoch 21/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:37<00:00,  2.10it/s, loss=4.8097, ppl=122.70]
<> Validating...

<> Epoch 21 Results:
<>  Time: 0:49:41
Train Loss: 4.5225 | Train PPL: 92.07
Valid Loss: 4.5271 | Valid PPL: 92.49
<> Saved new best model with validation loss: 4.5271
Epoch 22/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:36<00:00,  2.10it/s, loss=4.8019, ppl=121.75]
<> Validating...

<> Epoch 22 Results:
<>  Time: 0:49:39
Train Loss: 4.5127 | Train PPL: 91.16
Valid Loss: 4.5204 | Valid PPL: 91.87
<> Saved new best model with validation loss: 4.5204
Epoch 23/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:35<00:00,  2.10it/s, loss=4.7909, ppl=120.41]
<> Validating...

<> Epoch 23 Results:
<>  Time: 0:49:38
Train Loss: 4.5041 | Train PPL: 90.39
Valid Loss: 4.5142 | Valid PPL: 91.30
<> Saved new best model with validation loss: 4.5142
Epoch 24/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:35<00:00,  2.10it/s, loss=4.7882, ppl=120.09]
<> Validating...

<> Epoch 24 Results:
<>  Time: 0:49:38
Train Loss: 4.4969 | Train PPL: 89.74
Valid Loss: 4.5087 | Valid PPL: 90.80
<> Saved new best model with validation loss: 4.5087
Epoch 25/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:34<00:00,  2.10it/s, loss=4.7794, ppl=119.03]
<> Validating...

<> Epoch 25 Results:
<>  Time: 0:49:37
Train Loss: 4.4908 | Train PPL: 89.19
Valid Loss: 4.5054 | Valid PPL: 90.51
<> Saved new best model with validation loss: 4.5054
Epoch 26/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:38<00:00,  2.10it/s, loss=4.7834, ppl=119.51]
<> Validating...

<> Epoch 26 Results:
<>  Time: 0:49:41
Train Loss: 4.4859 | Train PPL: 88.76
Valid Loss: 4.5022 | Valid PPL: 90.22
<> Saved new best model with validation loss: 4.5022
Epoch 27/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:38<00:00,  2.10it/s, loss=4.7829, ppl=119.45]
<> Validating...

<> Epoch 27 Results:
<>  Time: 0:49:41
Train Loss: 4.4823 | Train PPL: 88.44
Valid Loss: 4.4999 | Valid PPL: 90.01
<> Saved new best model with validation loss: 4.4999
Epoch 28/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:33<00:00,  2.10it/s, loss=4.7807, ppl=119.19]
<> Validating...

<> Epoch 28 Results:
<>  Time: 0:49:36
Train Loss: 4.4797 | Train PPL: 88.21
Valid Loss: 4.4983 | Valid PPL: 89.86
<> Saved new best model with validation loss: 4.4983
Epoch 29/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:35<00:00,  2.10it/s, loss=4.7823, ppl=119.38]
<> Validating...

<> Epoch 29 Results:
<>  Time: 0:49:38
Train Loss: 4.4779 | Train PPL: 88.05
Valid Loss: 4.4976 | Valid PPL: 89.80
<> Saved new best model with validation loss: 4.4976
Epoch 30/30: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████| 6258/6258 [49:34<00:00,  2.10it/s, loss=4.7802, ppl=119.13]
<> Validating...

<> Epoch 30 Results:
<>  Time: 0:49:37
Train Loss: 4.4770 | Train PPL: 87.97
Valid Loss: 4.4974 | Valid PPL: 89.79
<> Saved new best model with validation loss: 4.4974

==================================================
<> Training Complete!
==================================================
Best validation loss: 4.4974
Total time: 1 day, 0:51:59

<> Training Finished. Loading Best Model for Evaluation...
<> Loaded checkpoint from epoch 29 (Loss: 4.4974)

Running Standard Evaluation...

==================================================
<> Starting STANDARD CHUNKED Evaluation...
==================================================
Evaluating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 14/14 [00:07<00:00,  1.91it/s]
==================================================
RESULTS: Standard Chunked
==================================================
Total Tokens: 229376
Average Loss: 3.4717
PERPLEXITY  : 32.19
==================================================


Running Sliding Window Evaluation (This will take longer)...

==================================================
<> Starting SLIDING WINDOW Evaluation (Stride=512)...
<> Note: This provides the most accurate Perplexity.
==================================================
>> Flattening test data for sliding window...
Sliding Window: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 444/444 [00:22<00:00, 19.49it/s]
==================================================
RESULTS: Sliding Window
==================================================
Total Tokens: 227328
Average Loss: 3.4631
PERPLEXITY  : 31.91
==================================================